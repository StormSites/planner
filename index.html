<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center | Privacy Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8f9fa; color: #1a1a1a; }
        .sidebar-active { background: #f3f4f6; color: #000; border-right: 3px solid #000; }
        .widget-ghost { opacity: 0.4; background: #e5e7eb; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border-top: 1px solid #e2e8f0; border-left: 1px solid #e2e8f0; }
        .calendar-day { min-height: 120px; padding: 0.5rem; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; background: white; }
        .calendar-day-header { background: #f1f5f9; padding: 0.5rem; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; text-align: center; font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; }
        .today { background: #f8fafc; }
        .today .day-num { background: black; color: white; border-radius: 999px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }
        .other-month { color: #cbd5e1; background: #fcfdfe; }
        
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .btn-primary { background: black; color: white; transition: all 0.2s; }
        .btn-primary:hover { background: #222; transform: translateY(-1px); }
    </style>
</head>
<body>
    <div id="app" class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r flex flex-col shrink-0 overflow-y-auto hide-scrollbar">
            <div class="p-6">
                <div class="flex items-center gap-2 mb-8">
                    <div class="w-8 h-8 rounded-lg bg-black flex items-center justify-center text-white">
                        <i data-lucide="shield-check" class="w-5 h-5"></i>
                    </div>
                    <h1 class="font-bold text-xl tracking-tight">Planner</h1>
                </div>
                
                <nav id="sidebar-nav" class="space-y-1">
                    <!-- Nav items injected based on enabled features -->
                </nav>
            </div>

            <div class="mt-auto p-4 border-t bg-slate-50/50">
                <button onclick="setView('settings')" id="nav-settings" class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-slate-500 hover:bg-slate-50 transition-all">
                    <i data-lucide="settings" class="w-4 h-4"></i> Settings
                </button>
            </div>
        </aside>

        <!-- Main Wrapper -->
        <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
            <header class="h-16 bg-white border-b px-8 flex items-center justify-between shrink-0 z-20">
                <div class="flex items-center gap-4">
                    <h2 id="page-title" class="text-lg font-bold text-slate-800">Command Center</h2>
                </div>
                <div class="flex items-center gap-6">
                    <div id="clock" class="text-xs font-bold text-slate-400 tracking-wider"></div>
                    <button onclick="openQuickAdd()" class="btn-primary px-5 py-2 rounded-full text-xs font-bold flex items-center gap-2 shadow-lg shadow-black/10">
                        <i data-lucide="plus" class="w-4 h-4"></i> Quick Add
                    </button>
                </div>
            </header>

            <div id="viewport" class="flex-1 overflow-y-auto p-8 scroll-smooth bg-slate-50">
                <!-- Content -->
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div id="modal-card" class="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[90vh] flex flex-col overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center bg-white sticky top-0">
                <h3 id="modal-title" class="font-bold text-xl">Quick Add</h3>
                <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="modal-body" class="p-8 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        // --- Database ---
        const db = new Dexie("PlannerProDB");
        db.version(1).stores({
            tasks: '++id, title, status, priority, dueDate, classId, projectId',
            projects: '++id, name, status, deadline, progress',
            school: '++id, className, schedule',
            assignments: '++id, title, classId, dueDate, status',
            events: '++id, title, start, end, category',
            habits: '++id, name, streak, logs',
            extra: '++id, name, role',
            settings: 'key, value'
        });

        // --- Auth/State ---
        let currentView = 'dashboard';
        let calendarDate = new Date();
        let config = JSON.parse(localStorage.getItem('planner_config')) || {
            enabledFeatures: {
                tasks: true,
                projects: true,
                school: true,
                habits: true,
                events: true,
                extra: true
            },
            dashboardMode: 'command',
            autoCarryover: true
        };

        const featureMeta = {
            tasks: { label: 'Tasks', icon: 'check-circle' },
            projects: { label: 'Projects', icon: 'folder-kanban' },
            school: { label: 'School', icon: 'graduation-cap' },
            habits: { label: 'Habits', icon: 'flame' },
            events: { label: 'Schedule', icon: 'calendar' },
            extra: { label: 'Activities', icon: 'star' }
        };

        // --- Rendering Engine ---
        async function setView(view) {
            currentView = view;
            localStorage.setItem('last_view', view);
            updateSidebar();
            
            const vp = document.getElementById('viewport');
            const title = document.getElementById('page-title');
            title.innerText = view === 'dashboard' ? 'Command Center' : view.charAt(0).toUpperCase() + view.slice(1);
            
            vp.innerHTML = '<div class="flex items-center justify-center h-full"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-black"></div></div>';
            
            switch(view) {
                case 'dashboard': await renderDashboard(vp); break;
                case 'tasks': await renderTasks(vp); break;
                case 'projects': await renderProjects(vp); break;
                case 'school': await renderSchool(vp); break;
                case 'habits': await renderHabits(vp); break;
                case 'events': await renderEvents(vp); break;
                case 'extra': await renderExtra(vp); break;
                case 'settings': renderSettings(vp); break;
            }
            lucide.createIcons();
        }

        function updateSidebar() {
            const nav = document.getElementById('sidebar-nav');
            let html = `
                <button onclick="setView('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg transition-all ${currentView==='dashboard'?'sidebar-active':''}">
                    <i data-lucide="layout-grid" class="w-4 h-4"></i> Command Center
                </button>
                <div class="pt-4 pb-2 px-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Modules</div>
            `;
            
            Object.keys(config.enabledFeatures).forEach(key => {
                if(config.enabledFeatures[key]) {
                    const meta = featureMeta[key];
                    html += `
                        <button onclick="setView('${key}')" id="nav-${key}" class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-slate-500 hover:bg-slate-50 transition-all ${currentView===key?'sidebar-active':''}">
                            <i data-lucide="${meta.icon}" class="w-4 h-4"></i> ${meta.label}
                        </button>
                    `;
                }
            });
            nav.innerHTML = html;
            lucide.createIcons();
        }

        // --- Dashboard ---
        async function renderDashboard(vp) {
            vp.innerHTML = `<div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>`;
            const grid = document.getElementById('dashboard-grid');
            
            const widgets = {
                tasks: async () => {
                    const data = await db.tasks.where('status').notEqual('done').limit(5).toArray();
                    return renderWidget('Active Tasks', data.map(t => `<div class="flex items-center gap-3 mb-2"><input type="checkbox" onchange="toggleTask(${t.id})" class="accent-black"><span class="text-xs font-medium">${t.title}</span></div>`).join('') || '<p class="text-xs text-slate-400">No tasks</p>');
                },
                events: async () => {
                    const data = await db.events.limit(3).toArray();
                    return renderWidget('Schedule', data.map(e => `<div class="p-2 bg-slate-100 rounded-lg mb-2"><p class="text-[10px] font-bold">${e.title}</p></div>`).join('') || '<p class="text-xs text-slate-400">Empty</p>');
                },
                projects: async () => {
                   const data = await db.projects.limit(2).toArray();
                   return renderWidget('Projects', data.map(p => `<div class="mb-2"><p class="text-[10px] font-bold mb-1">${p.name}</p><div class="h-1 w-full bg-slate-100 rounded-full overflow-hidden"><div class="bg-black h-full" style="width:${p.progress}%"></div></div></div>`).join('') || '<p class="text-xs text-slate-400">None</p>');
                },
                habits: async () => {
                    const data = await db.habits.limit(3).toArray();
                    return renderWidget('Habits', data.map(h => `<div class="flex justify-between text-xs mb-2"><span>${h.name}</span><span class="font-bold text-orange-500">${h.streak}d</span></div>`).join(''));
                }
            };

            for(let key of Object.keys(config.enabledFeatures)) {
                if(config.enabledFeatures[key] && widgets[key]) {
                    grid.innerHTML += await widgets[key]();
                }
            }
        }

        function renderWidget(title, content) {
            return `<div class="card p-6 min-h-[200px] flex flex-col"><h4 class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-4">${title}</h4><div class="flex-1">${content}</div></div>`;
        }

        // --- Calendar Component ---
        async function renderEvents(vp) {
            const month = calendarDate.getMonth();
            const year = calendarDate.getFullYear();
            const monthName = calendarDate.toLocaleString('default', { month: 'long' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const events = await db.events.toArray();

            vp.innerHTML = `
                <div class="calendar-container card bg-white overflow-hidden flex flex-col h-full">
                    <div class="p-4 border-b flex items-center justify-between">
                        <h3 class="font-bold text-xl">${monthName} ${year}</h3>
                        <div class="flex gap-2">
                            <button onclick="navCal(-1)" class="p-2 hover:bg-slate-100 rounded-lg"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                            <button onclick="calendarDate=new Date(); setView('events')" class="px-4 py-2 text-xs font-bold uppercase uppercase text-slate-500">Today</button>
                            <button onclick="navCal(1)" class="p-2 hover:bg-slate-100 rounded-lg"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <div class="calendar-grid flex-1 overflow-y-auto">
                        <div class="calendar-day-header">Sun</div><div class="calendar-day-header">Mon</div><div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div><div class="calendar-day-header">Thu</div><div class="calendar-day-header">Fri</div><div class="calendar-day-header">Sat</div>
                        ${renderCalendarDays(year, month, firstDay, daysInMonth, events)}
                    </div>
                </div>
            `;
        }

        function navCal(move) {
            calendarDate.setMonth(calendarDate.getMonth() + move);
            setView('events');
        }

        function renderCalendarDays(year, month, firstDay, daysInMonth, events) {
            let html = '';
            // Previous month overflow
            for(let i = 0; i < firstDay; i++) html += `<div class="calendar-day other-month"></div>`;
            
            const today = new Date().toISOString().split('T')[0];
            
            for(let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isToday = dateStr === today;
                const dayEvents = events.filter(e => e.start.startsWith(dateStr));

                html += `
                    <div class="calendar-day ${isToday?'today':''}">
                        <div class="day-num text-xs font-bold mb-2">${d}</div>
                        <div class="space-y-1">
                            ${dayEvents.map(e => `<div class="bg-indigo-600 text-[9px] text-white p-1 rounded truncate pointer-events-none">${e.title}</div>`).join('')}
                        </div>
                    </div>
                `;
            }
            return html;
        }

        // --- Module Implementations ---
        async function renderTasks(vp) {
            const data = await db.tasks.toArray();
            vp.innerHTML = `<div class="max-w-3xl mx-auto space-y-4">
                ${data.map(t => `<div class="card p-4 flex items-center justify-between">
                    <div class="flex items-center gap-4"><input type="checkbox" onchange="toggleTask(${t.id})" ${t.status==='done'?'checked':''} class="w-5 h-5 accent-black">
                    <span class="${t.status==='done'?'line-through text-slate-400':'font-bold'}">${t.title}</span></div>
                    <button onclick="deleteItem('tasks', ${t.id})" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>`).join('') || '<p class="text-center text-slate-400 py-10">No tasks found.</p>'}
            </div>`;
        }

        async function renderProjects(vp) {
            const data = await db.projects.toArray();
            vp.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                ${data.map(p => `<div class="card p-6">
                    <h3 class="font-bold text-lg mb-2">${p.name}</h3>
                    <div class="flex items-center gap-3 mb-6"><div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden"><div class="bg-green-500 h-full" style="width:${p.progress}%"></div></div><span class="text-xs font-black">${p.progress}%</span></div>
                    <div class="flex gap-2">
                        <button onclick="updateProj(${p.id}, 10)" class="flex-1 py-2 bg-slate-50 border rounded-lg text-xs font-bold">+10%</button>
                        <button onclick="deleteItem('projects', ${p.id})" class="p-2 border rounded-lg"><i data-lucide="trash-2" class="w-4 h-4 text-red-400"></i></button>
                    </div>
                </div>`).join('')}
            </div>`;
        }

        async function renderSettings(vp) {
            vp.innerHTML = `
                <div class="max-w-2xl mx-auto space-y-8">
                    <section class="card p-8">
                        <h3 class="font-bold text-lg mb-6">Manage Modules</h3>
                        <div class="space-y-4">
                            ${Object.keys(featureMeta).map(key => `
                                <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl">
                                    <div class="flex items-center gap-3"><i data-lucide="${featureMeta[key].icon}" class="w-5 h-5 text-slate-500"></i><span class="font-bold text-sm">${featureMeta[key].label}</span></div>
                                    <button onclick="toggleFeature('${key}')" class="w-12 h-6 rounded-full relative transition-all ${config.enabledFeatures[key]?'bg-black':'bg-slate-300'}">
                                        <div class="w-4 h-4 bg-white rounded-full absolute top-1 transition-all ${config.enabledFeatures[key]?'right-1':'left-1'}"></div>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </section>

                    <section class="card p-8">
                        <h3 class="font-bold text-lg mb-6">Database Controls</h3>
                        <div class="flex gap-4">
                            <button onclick="exportJSON()" class="flex-1 py-3 bg-slate-100 rounded-xl text-xs font-bold uppercase transition-all hover:bg-slate-200">Export Backup</button>
                            <button onclick="factoryReset()" class="flex-1 py-3 bg-red-50 text-red-600 rounded-xl text-xs font-bold uppercase transition-all hover:bg-red-100">Clear All Data</button>
                        </div>
                    </section>
                </div>
            `;
            lucide.createIcons();
        }

        // --- Handlers ---
        function toggleFeature(key) {
            config.enabledFeatures[key] = !config.enabledFeatures[key];
            localStorage.setItem('planner_config', JSON.stringify(config));
            setView('settings');
        }

        async function toggleTask(id) {
            const t = await db.tasks.get(id);
            await db.tasks.update(id, { status: t.status === 'done' ? 'pending' : 'done' });
            setView(currentView);
        }

        async function updateProj(id, amt) {
            const p = await db.projects.get(id);
            await db.projects.update(id, { progress: Math.min(p.progress + amt, 100) });
            setView(currentView);
        }

        async function deleteItem(table, id) {
            if(confirm('Delete permanently?')) {
                await db[table].delete(id);
                setView(currentView);
            }
        }

        async function factoryReset() {
            if(confirm('This will wipe all local data. Continue?')) {
                await db.delete();
                localStorage.clear();
                window.location.reload();
            }
        }

        function openQuickAdd() {
            const enabled = Object.keys(config.enabledFeatures).filter(k => config.enabledFeatures[k]);
            openModal('Quick Add', `
                <div class="grid grid-cols-2 gap-3">
                    ${enabled.map(k => `
                        <button onclick="renderAddForm('${k}')" class="p-6 border rounded-2xl hover:bg-slate-50 text-left transition-all">
                            <p class="text-[10px] font-black uppercase text-slate-400 mb-1">${k}</p>
                            <p class="font-bold text-sm">${featureMeta[k].label}</p>
                        </button>
                    `).join('')}
                </div>
            `);
        }

        function renderAddForm(key) {
            let html = `<form onsubmit="saveEntry(event, '${key}')" class="space-y-4">`;
            switch(key) {
                case 'tasks': 
                    html += `<input name="title" required placeholder="Task name..." class="w-full p-4 bg-slate-50 border-none rounded-2xl">`;
                    break;
                case 'projects':
                    html += `<input name="name" required placeholder="Project title..." class="w-full p-4 bg-slate-50 border-none rounded-2xl">`;
                    break;
                case 'events':
                    html += `
                        <input name="title" required placeholder="Event name..." class="w-full p-4 bg-slate-50 border-none rounded-2xl mb-2">
                        <label class="text-[10px] font-bold text-slate-400 ml-2">START TIME</label>
                        <input name="start" type="datetime-local" class="w-full p-4 bg-slate-50 border-none rounded-2xl">
                    `;
                    break;
                default:
                    html += `<input name="name" required placeholder="Name..." class="w-full p-4 bg-slate-50 border-none rounded-2xl">`;
            }
            html += `<button type="submit" class="w-full py-4 bg-black text-white font-bold rounded-2xl mt-4">Save Entry</button></form>`;
            document.getElementById('modal-body').innerHTML = html;
        }

        async function saveEntry(e, key) {
            e.preventDefault();
            const fd = new FormData(e.target);
            const data = Object.fromEntries(fd.entries());
            if(key === 'tasks') data.status = 'pending';
            if(key === 'projects') data.progress = 0;
            if(key === 'habits') data.streak = 0;
            
            await db[key].add(data);
            closeModal();
            setView(currentView);
        }

        function openModal(title, content) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal-overlay').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }

        async function exportJSON() {
            const data = {};
            for(let store of db.tables) data[store.name] = await store.toArray();
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        // --- System Init ---
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }) + ' â€¢ ' + now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }, 1000);

        window.onload = () => {
            const last = localStorage.getItem('last_view') || 'dashboard';
            setView(last);
        };
    </script>
</body>
</html>
