<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Planner | Command Center</title>
    <!-- ADDED: Favicon matching the dashboard icon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><rect width='7' height='9' x='3' y='3' rx='1'/><rect width='7' height='5' x='14' y='3' rx='1'/><rect width='7' height='9' x='14' y='12' rx='1'/><rect width='7' height='5' x='3' y='16' rx='1'/></svg>">
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- ADDED: ICS Parser Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.5.0/ical.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        
        :root {
            --brand-primary: #6366f1;
            --brand-bg: #f8fafc;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--brand-bg);
            color: #1e293b;
        }

        /* Sidebar State */
        .nav-active {
            background: #eff6ff;
            color: #2563eb !important;
            font-weight: 700 !important;
            border-right: 3px solid #2563eb;
        }

        /* Dashboard Widget Transitions */
        .widget-ghost {
            opacity: 0.3;
            background: #e2e8f0;
        }

        /* Google Calendar Grid Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border-top: 1px solid #e2e8f0;
            border-left: 1px solid #e2e8f0;
        }

        /* CALENDAR SCROLL FIXES */
        .calendar-scroll-area {
            overflow-y: auto;
            flex: 1;
            max-height: calc(100vh - 320px);
        }

        .calendar-day-header {
            position: sticky;
            top: 0;
            /* FIXED: Lowered z-index so it stays under main header */
            z-index: 5; 
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .calendar-cell {
            min-height: 120px;
            background: white;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            padding: 8px;
            transition: background 0.2s;
        }

        .calendar-cell:hover {
            background: #fdfdfd;
        }

        .calendar-cell.other-month {
            background: #f1f5f9;
            color: #94a3b8;
        }

        .calendar-cell.today {
            background: #f0f9ff;
        }

        .calendar-cell.today .day-label {
            background: #2563eb;
            color: white;
            border-radius: 999px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center; justify-content: center;
        }

        .event-chip {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis;
            cursor: pointer;
        }

        /* Scrollbar styling */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Dashboard Modes */
        .minimal-mode .widget-header { display: none; }
        .minimal-mode .widget-card { border: none; box-shadow: none; background: transparent; padding: 0.5rem 0; }
        
        /* Custom Checkbox */
        input[type="checkbox"] {
            width: 1.2rem;
            height: 1.2rem;
            accent-color: #2563eb;
            cursor: pointer;
        }

        /* UPDATED: Improved Tab Action Buttons */
        .btn-tab-action {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: white;
            color: #475569;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            white-space: nowrap;
        }
        .btn-tab-action:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }
        .btn-tab-action i {
            width: 14px;
            height: 14px;
        }

        /* Modal Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-in { animation: fadeIn 0.2s ease-out; }
        .zoom-in { animation: zoomIn 0.2s ease-out; }

        /* ADDED: Priority Colors */
        .prio-3 { border-left: 4px solid #ef4444 !important; } 
        .prio-2 { border-left: 4px solid #f59e0b !important; } 
        .prio-1 { border-left: 4px solid #3b82f6 !important; }

        /* FIXED: Header Spacing & Layout */
        #tab-action-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 16px;
        }

        /* FIXED: Header Stacking */
        header {
            position: sticky;
            top: 0;
            z-index: 40 !important;
        }
    </style>
</head>
<body class="overflow-hidden">

    <div id="app" class="flex h-screen w-full">
        <!-- Main Sidebar -->
        <aside id="sidebar" class="w-72 bg-white border-r flex flex-col shrink-0">
            <div class="p-8 flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                    <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                </div>
                <!-- UPDATED: Application Name -->
                <h1 class="text-xl font-extrabold tracking-tight">Nexus Planner</h1>
            </div>

            <nav id="nav-container" class="flex-1 px-4 space-y-1 overflow-y-auto hide-scrollbar">
                <!-- Nav items generated dynamically -->
            </nav>

            <div class="p-6 border-t mt-auto">
                <button onclick="router.navigate('settings')" id="nav-settings" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-500 hover:bg-slate-50 rounded-xl transition-all">
                    <i data-lucide="settings" class="w-5 h-5"></i> Settings
                </button>
                <div class="mt-4 px-4 py-3 bg-slate-50 rounded-xl">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Local Privacy</p>
                    <p class="text-xs text-slate-500 mt-1">No Cloud. No Backend.</p>
                </div>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="flex-1 flex flex-col min-w-0 bg-slate-50 relative">
            <header class="h-20 bg-white/95 backdrop-blur-sm border-b px-10 flex items-center justify-between shrink-0 z-40">
                <div class="flex items-center gap-8 flex-1 min-w-0">
                    <div class="flex flex-col shrink-0">
                        <div class="flex items-center">
                            <h2 id="view-title" class="text-xl font-black text-slate-800 whitespace-nowrap">Command Center</h2>
                            <div id="tab-action-container"></div>
                        </div>
                        <p id="view-subtitle" class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-0.5"></p>
                    </div>

                    <!-- Global Search Input -->
                    <div class="relative w-full max-w-md hidden lg:block">
                        <i data-lucide="search" class="absolute left-4 top-3 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="global-search" oninput="logic.search(this.value)" placeholder="Search tasks, projects, etc..." class="w-full bg-slate-100 border-none rounded-2xl py-2.5 pl-11 pr-4 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                    </div>
                </div>

                <div class="flex items-center gap-6 shrink-0 ml-4">
                    <div id="clock-display" class="text-right hidden md:block">
                        <div id="clock-time" class="text-sm font-bold text-slate-700"></div>
                        <div id="clock-date" class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter"></div>
                    </div>
                    <button onclick="ui.modal.openQuickAdd()" class="bg-indigo-600 text-white px-6 py-2.5 rounded-full text-sm font-bold shadow-lg shadow-indigo-100 hover:scale-105 active:scale-95 transition-all flex items-center gap-2 whitespace-nowrap">
                        <i data-lucide="plus" class="w-4 h-4"></i> New Entry
                    </button>
                </div>
            </header>

            <!-- UPDATED: Footer is now inside the scrollable container so it is NOT sticky -->
            <div class="flex-1 overflow-y-auto scroll-smooth flex flex-col">
                <div id="viewport" class="flex-1 p-10">
                    <!-- Data views injected here -->
                </div>

                <footer class="p-10 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest border-t bg-white/50 backdrop-blur-sm">
                    <a href="https://example.com" class="hover:text-indigo-600 transition-colors">Nexus Planner</a> © 2026 by <a href="https://derrickrichard.github.io/profile/" class="hover:text-indigo-600 transition-colors">Derrick Richard</a> is licensed under <a href="https://creativecommons.org/licenses/by-nd/4.0/" class="hover:text-indigo-600 transition-colors">CC BY-ND 4.0</a><img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" alt="" style="max-width: 1em;max-height:1em;margin-left: .2em; display: inline-block; vertical-align: middle;"><img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" alt="" style="max-width: 1em;max-height:1em;margin-left: .2em; display: inline-block; vertical-align: middle;"><img src="https://mirrors.creativecommons.org/presskit/icons/nd.svg" alt="" style="max-width: 1em;max-height:1em;margin-left: .2em; display: inline-block; vertical-align: middle;">
                </footer>
            </div>
        </main>
    </div>

    <!-- Universal Modal System -->
    <div id="modal-overlay" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div id="modal-container" class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col overflow-hidden animate-in zoom-in">
            <div class="p-8 border-b flex justify-between items-center bg-white sticky top-0">
                <div class="flex flex-col">
                    <h3 id="modal-title" class="text-2xl font-bold">Quick Add</h3>
                    <p id="modal-subtitle" class="text-sm text-slate-400 font-medium"></p>
                </div>
                <div class="flex items-center gap-2">
                    <div id="modal-actions"></div>
                    <button onclick="ui.modal.close()" class="p-3 hover:bg-slate-100 rounded-full transition-colors text-slate-400"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
            </div>
            <div id="modal-body" class="p-8 overflow-y-auto bg-slate-50/30">
            </div>
        </div>
    </div>

    <script>
        /** 
         * 1. DATABASE LAYER 
         */
        const db = new Dexie("PlannerCompleteStorage");
        db.version(1).stores({
            tasks: '++id, title, status, priority, dueDate, section, projectId, classId, isRecurring, description',
            projects: '++id, name, status, progress, deadline, description',
            school: '++id, className, instructor, semester',
            assignments: '++id, title, classId, dueDate, status, weight',
            events: '++id, title, start, end, location, category, description',
            habits: '++id, name, streak, logs, goal',
            extra: '++id, name, role, hours',
            settings: 'key, value',
            backups: '++id, timestamp'
        });

        /**
         * 2. STATE & CONFIGURATION 
         */
        const defaultConfig = {
            dashboardMode: 'command',
            features: {
                tasks: true,
                projects: true,
                school: true,
                habits: true,
                events: true,
                extra: true
            },
            automation: {
                autoCarryover: true,
                smartSort: true
            }
        };

        const localConfig = JSON.parse(localStorage.getItem('app_config')) || {};
        const state = {
            currentView: 'dashboard',
            currentCalendarDate: new Date(),
            dashboardLayout: JSON.parse(localStorage.getItem('dashboard_layout')) || ['focus', 'tasks', 'schedule', 'habits', 'projects', 'school', 'extra'],
            searchQuery: '',
            pomodoro: { time: 1500, active: false, interval: null },
            config: {
                ...defaultConfig,
                ...localConfig,
                features: { ...defaultConfig.features, ...(localConfig.features || {}) },
                automation: { ...defaultConfig.automation, ...(localConfig.automation || {}) }
            }
        };

        const FEATURE_META = {
            dashboard: { id: 'dashboard', label: 'Command Center', icon: 'home' },
            tasks: { id: 'tasks', label: 'Daily Tasks', icon: 'check-square' },
            assignment: { id: 'assignment', label: 'Homework', icon: 'book-open' },
            projects: { id: 'projects', label: 'Projects', icon: 'briefcase' },
            school: { id: 'school', label: 'Education', icon: 'graduation-cap' },
            habits: { id: 'habits', label: 'Habits', icon: 'flame' },
            events: { id: 'events', label: 'Calendar', icon: 'calendar' },
            extra: { id: 'extra', label: 'Activities', icon: 'star' }
        };

        const PRIORITY_LABELS = { "1": "Low", "2": "Medium", "3": "High" };

        /**
         * 3. UI CONTROLLER 
         */
        const ui = {
            init: async () => {
                ui.refreshNavigation();
                ui.updateClock();
                setInterval(ui.updateClock, 1000);
                await automation.runner();
                router.load('dashboard');
            },

            refreshNavigation: () => {
                const nav = document.getElementById('nav-container');
                let html = `
                    <button onclick="router.navigate('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-all">
                        <i data-lucide="home" class="w-5 h-5"></i> Dashboard
                    </button>
                    <div class="pt-6 pb-2 px-4 text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">Personal Modules</div>
                `;

                Object.keys(state.config.features).forEach(key => {
                    if (state.config.features[key]) {
                        const meta = FEATURE_META[key];
                        html += `
                            <button onclick="router.navigate('${key}')" id="nav-${key}" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-500 hover:bg-slate-50 rounded-xl transition-all">
                                <i data-lucide="${meta.icon}" class="w-5 h-5"></i> ${meta.label}
                            </button>
                        `;
                    }
                });

                nav.innerHTML = html;
                lucide.createIcons();
            },

            updateClock: () => {
                const now = new Date();
                const clockTime = document.getElementById('clock-time');
                const clockDate = document.getElementById('clock-date');
                if (!clockTime) return;
                clockTime.innerText = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
                clockDate.innerText = now.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            },

            modal: {
                open: (title, subtitle, bodyHtml, actionsHtml = '') => {
                    document.getElementById('modal-title').innerText = title;
                    document.getElementById('modal-subtitle').innerText = subtitle;
                    document.getElementById('modal-body').innerHTML = bodyHtml;
                    document.getElementById('modal-actions').innerHTML = actionsHtml;
                    document.getElementById('modal-overlay').classList.remove('hidden');
                    lucide.createIcons();
                },
                close: () => {
                    document.getElementById('modal-overlay').classList.add('hidden');
                },
                openQuickAdd: () => {
                    const enabled = Object.keys(state.config.features).filter(f => state.config.features[f]);
                    let html = `<div class="grid grid-cols-2 gap-4">`;
                    enabled.forEach(key => {
                        html += `
                            <button onclick="ui.modal.renderForm('${key}')" class="flex flex-col items-start p-6 bg-white border border-slate-200 rounded-3xl hover:border-indigo-500 hover:bg-indigo-50/50 transition-all group">
                                <i data-lucide="${FEATURE_META[key].icon}" class="w-6 h-6 text-slate-400 group-hover:text-indigo-600 mb-4 transition-colors"></i>
                                <span class="font-bold text-slate-700">${FEATURE_META[key].label}</span>
                                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-1">Create New</span>
                            </button>
                        `;
                    });
                    html += `
                        <button onclick="ui.modal.renderForm('assignment')" class="flex flex-col items-start p-6 bg-indigo-50 border border-indigo-100 rounded-3xl hover:border-indigo-500 hover:bg-indigo-50 transition-all group">
                            <i data-lucide="book-open" class="w-6 h-6 text-indigo-400 group-hover:text-indigo-600 mb-4 transition-colors"></i>
                            <span class="font-bold text-indigo-700">Assignment</span>
                            <span class="text-[10px] text-indigo-400 font-bold uppercase tracking-wider mt-1">School Homework</span>
                        </button>
                    `;
                    html += `</div>`;
                    ui.modal.open("New Entry", "Choose what you want to add to your planner", html);
                },
                renderForm: async (key, editId = null) => {
                    const editData = editId ? await db[key==='assignment'?'tasks':key].get(editId) : null;
                    let formHtml = `<form onsubmit="logic.handleForm(event, '${key === 'assignment' ? 'tasks' : key}', ${editId})" class="space-y-6">`;
                    switch(key) {
                        case 'assignment':
                        case 'tasks':
                            const schoolClasses = await db.school.toArray();
                            formHtml += `
                                <div><label class="block text-xs font-black uppercase text-slate-400 mb-2">Title</label><input name="title" required value="${editData?.title || ''}" class="w-full p-4 bg-white border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500" placeholder="${key === 'assignment' ? 'e.g. History Essay' : 'e.g. Finish quarterly report'}"></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-xs font-black uppercase text-slate-400 mb-2">Priority</label>
                                        <select name="priority" class="w-full p-4 bg-white border border-slate-200 rounded-2xl">
                                            <option value="1" ${editData?.priority==1?'selected':''}>Low</option>
                                            <option value="2" ${!editData||editData.priority==2?'selected':''}>Medium</option>
                                            <option value="3" ${editData?.priority==3?'selected':''}>High</option>
                                        </select>
                                    </div>
                                    <div><label class="block text-xs font-black uppercase text-slate-400 mb-2">Due Date</label><input type="date" name="dueDate" class="w-full p-4 bg-white border border-slate-200 rounded-2xl" value="${editData?.dueDate || new Date().toISOString().split('T')[0]}"></div>
                                </div>
                                <div><label class="block text-xs font-black uppercase text-slate-400 mb-2">Description</label><textarea name="description" class="w-full p-4 bg-white border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 h-24" placeholder="Add more details...">${editData?.description || ''}</textarea></div>
                                <div>
                                    <label class="block text-xs font-black uppercase text-slate-400 mb-2">Link to Class (Required for Homework)</label>
                                    <select name="classId" class="w-full p-4 bg-white border border-slate-200 rounded-2xl" ${key === 'assignment' ? 'required' : ''}>
                                        <option value="">${key === 'assignment' ? '-- Select a Class --' : 'No Class'}</option>
                                        ${schoolClasses.map(c => `<option value="${c.id}" ${editData?.classId==c.id?'selected':''}>${c.className}</option>`).join('')}
                                    </select>
                                    ${schoolClasses.length === 0 ? '<p class="text-[10px] text-red-500 mt-2 font-bold uppercase">Add classes in Education tab first!</p>' : ''}
                                </div>
                            `;
                            break;
                        case 'events':
                            formHtml += `
                                <div><label class="block text-xs font-black uppercase text-slate-400 mb-2">Event Title</label><input name="title" required value="${editData?.title || ''}" class="w-full p-4 bg-white border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500"></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-xs font-black uppercase text-slate-400 mb-2">Start</label><input type="datetime-local" name="start" required class="w-full p-4 bg-white border border-slate-200 rounded-2xl" value="${editData?.start || new Date().toISOString().slice(0, 16)}"></div>
                                    <div><label class="block text-xs font-black uppercase text-slate-400 mb-2">End</label><input type="datetime-local" name="end" required class="w-full p-4 bg-white border border-slate-200 rounded-2xl" value="${editData?.end || new Date().toISOString().slice(0, 16)}"></div>
                                </div>
                                <div><label class="block text-xs font-black uppercase text-slate-400 mb-2">Description</label><textarea name="description" class="w-full p-4 bg-white border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 h-24" placeholder="Location, notes, etc...">${editData?.description || ''}</textarea></div>
                            `;
                            break;
                        case 'projects':
                            formHtml += `
                                <div><label class="block text-xs font-black uppercase text-slate-400 mb-2">Project Name</label><input name="name" required value="${editData?.name || ''}" class="w-full p-4 bg-white border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500"></div>
                                <div><label class="block text-xs font-black uppercase text-slate-400 mb-2">Deadline</label><input type="date" name="deadline" class="w-full p-4 bg-white border border-slate-200 rounded-2xl" value="${editData?.deadline || new Date().toISOString().split('T')[0]}"></div>
                                <div><label class="block text-xs font-black uppercase text-slate-400 mb-2">Description</label><textarea name="description" class="w-full p-4 bg-white border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 h-24" placeholder="What is this project about?">${editData?.description || ''}</textarea></div>
                            `;
                            break;
                        case 'habits':
                            formHtml += `
                                <div><label class="block text-xs font-black uppercase text-slate-400 mb-2">Habit Action</label><input name="name" required value="${editData?.name || ''}" placeholder="e.g. Meditate" class="w-full p-4 bg-white border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500"></div>
                            `;
                            break;
                        case 'school':
                            formHtml += `
                                <div><label class="block text-xs font-black uppercase text-slate-400 mb-2">Class Name</label><input name="className" required value="${editData?.className || ''}" placeholder="e.g. Physics 101" class="w-full p-4 bg-white border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500"></div>
                                <div><label class="block text-xs font-black uppercase text-slate-400 mb-2">Instructor</label><input name="instructor" value="${editData?.instructor || ''}" class="w-full p-4 bg-white border border-slate-200 rounded-2xl outline-none"></div>
                            `;
                            break;
                        case 'extra':
                            formHtml += `
                                <div><label class="block text-xs font-black uppercase text-slate-400 mb-2">Activity Name</label><input name="name" required value="${editData?.name || ''}" class="w-full p-4 bg-white border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500"></div>
                            `;
                            break;
                    }
                    formHtml += `<button type="submit" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-xl mt-4">${editId ? 'Update' : 'Save'} Entry</button></form>`;
                    document.getElementById('modal-body').innerHTML = formHtml;
                    ui.modal.open(`${editId?'Edit':'Add'} ${key.charAt(0).toUpperCase() + key.slice(1)}`, `${editId?'Modify existing':'Create new'} details`, formHtml);
                }
            }
        };

        /**
         * 4. ROUTER & VIEWS 
         */
        const router = {
            navigate: (view) => {
                state.currentView = view;
                router.load(view);
                ui.refreshNavigation();
                const btn = document.getElementById(`nav-${view}`);
                if (btn) {
                    document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active'));
                    btn.classList.add('nav-active');
                }
            },

            load: async (view) => {
                const viewport = document.getElementById('viewport');
                const title = document.getElementById('view-title');
                const subtitle = document.getElementById('view-subtitle');
                const actionBtn = document.getElementById('tab-action-container');
                
                title.innerText = FEATURE_META[view]?.label || 'Settings';
                subtitle.innerText = `Manage your ${view} and organized life.`;

                if(view !== 'dashboard' && view !== 'settings') {
                    if (view === 'school') {
                        actionBtn.innerHTML = `
                            <button onclick="ui.modal.renderForm('school')" class="btn-tab-action">
                                <i data-lucide="plus-circle"></i> Add Class
                            </button>
                            <button onclick="ui.modal.renderForm('assignment')" class="btn-tab-action">
                                <i data-lucide="book-open"></i> HW
                            </button>
                        `;
                    } else if (view === 'events') {
                        actionBtn.innerHTML = `
                            <button onclick="ui.modal.renderForm('events')" class="btn-tab-action">
                                <i data-lucide="plus-circle"></i> Add
                            </button>
                            <button onclick="document.getElementById('ics-upload').click()" class="btn-tab-action">
                                <i data-lucide="file-up"></i> Import
                            </button>
                            <button onclick="logic.showImportInstructions()" class="btn-tab-action">
                                <i data-lucide="help-circle"></i> Help
                            </button>
                            <input type="file" id="ics-upload" class="hidden" accept=".ics" onchange="logic.importIcs(this)">
                        `;
                    } else {
                        actionBtn.innerHTML = `
                            <button onclick="ui.modal.renderForm('${view}')" class="btn-tab-action">
                                <i data-lucide="plus-circle"></i> Add ${view.charAt(0).toUpperCase() + view.slice(1, -1)}
                            </button>
                        `;
                    }
                } else { actionBtn.innerHTML = ''; }

                viewport.innerHTML = `<div class="flex items-center justify-center py-20"><div class="animate-spin h-8 w-8 border-4 border-indigo-600 border-t-transparent rounded-full"></div></div>`;
                switch(view) {
                    case 'dashboard': await renderers.dashboard(viewport); break;
                    case 'tasks': await renderers.tasks(viewport); break;
                    case 'projects': await renderers.projects(viewport); break;
                    case 'school': await renderers.school(viewport); break;
                    case 'habits': await renderers.habits(viewport); break;
                    case 'events': await renderers.events(viewport); break;
                    case 'extra': await renderers.extra(viewport); break;
                    case 'settings': renderers.settings(viewport); break;
                }
                lucide.createIcons();
            }
        };

        /**
         * 5. VIEW RENDERERS
         */
        const renderers = {
            dashboard: async (target) => {
                target.innerHTML = `
                    <div id="widget-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        ${state.dashboardLayout.map(wId => `
                            <div data-id="${wId}" class="widget-card bg-white border border-slate-200 rounded-3xl shadow-sm flex flex-col group min-h-[350px]">
                                <div class="widget-header px-8 py-5 border-b flex justify-between items-center cursor-move">
                                    <h3 class="text-xs font-black uppercase text-slate-400 tracking-widest">${wId}</h3>
                                    <i data-lucide="more-horizontal" class="w-4 h-4 text-slate-300"></i>
                                </div>
                                <div id="widget-content-${wId}" class="p-8 flex-1 overflow-y-auto hide-scrollbar">
                                    <div class="animate-pulse space-y-3"><div class="h-4 bg-slate-100 rounded w-3/4"></div><div class="h-4 bg-slate-100 rounded"></div></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                new Sortable(document.getElementById('widget-grid'), {
                    animation: 150, handle: '.widget-header', ghostClass: 'widget-ghost',
                    onEnd: (evt) => {
                        const newOrder = Array.from(evt.to.children).map(el => el.dataset.id);
                        localStorage.setItem('dashboard_layout', JSON.stringify(newOrder));
                    }
                });
                const loaders = {
                    focus: () => {
                        document.getElementById('widget-content-focus').innerHTML = `
                            <div class="flex flex-col items-center justify-center h-full gap-4">
                                <div id="pomo-timer" class="text-5xl font-black text-slate-800">${Math.floor(state.pomodoro.time/60)}:${(state.pomodoro.time%60).toString().padStart(2, '0')}</div>
                                <div class="flex gap-2">
                                    <button onclick="logic.togglePomodoro()" class="px-6 py-2 bg-indigo-600 text-white text-xs font-bold rounded-full">${state.pomodoro.active?'Pause':'Start Focus'}</button>
                                    <button onclick="state.pomodoro.time = 1500; router.load('dashboard')" class="p-2 border rounded-full text-slate-300"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        `;
                    },
                    tasks: async () => {
                        const tasks = await db.tasks.where('status').notEqual('done').limit(5).toArray();
                        document.getElementById('widget-content-tasks').innerHTML = tasks.length ? `<div class="space-y-4">${tasks.map(t => `<div onclick="logic.showDetails('tasks', ${t.id})" class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded-xl cursor-pointer"><div class="w-1.5 h-1.5 rounded-full ${t.priority==3?'bg-red-500':t.priority==2?'bg-amber-500':'bg-blue-500'}"></div> <span class="text-sm font-medium text-slate-600 truncate">${t.title}</span></div>`).join('')}</div>` : `<p class="text-slate-300 text-sm italic">No pending tasks.</p>`;
                    },
                    habits: async () => {
                        const habits = await db.habits.toArray();
                        document.getElementById('widget-content-habits').innerHTML = habits.length ? `<div class="space-y-6">${habits.map(h => `<div><div class="flex justify-between text-[11px] font-bold text-slate-500 uppercase mb-2"><span>${h.name}</span><span class="text-indigo-600">${h.streak}d</span></div><div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden"><div class="bg-indigo-600 h-full" style="width: ${Math.min(h.streak * 10, 100)}%"></div></div></div>`).join('')}</div>` : `<p class="text-slate-300 text-sm italic">No habits tracking.</p>`;
                    },
                    schedule: async () => {
                        const today = new Date().toISOString().split('T')[0];
                        const dayEvents = await db.events.where('start').startsWith(today).toArray();
                        document.getElementById('widget-content-schedule').innerHTML = dayEvents.length ? `<div class="space-y-4">${dayEvents.map(e => `<div class="flex gap-4 items-start cursor-pointer hover:bg-slate-50 p-1 rounded-lg" onclick="logic.showDetails('events', ${e.id})"><div class="w-1 text-[10px] font-bold text-slate-300 leading-tight pt-1 capitalize">${(e.start.split('T')[1] || "00:00").slice(0,5)}</div><div class="flex-1 bg-white border border-slate-100 p-3 rounded-xl"><p class="text-xs font-bold text-slate-700">${e.title}</p></div></div>`).join('')}</div>` : `<p class="text-slate-300 text-sm italic">No events today.</p>`;
                    },
                    projects: async () => {
                        const projs = await db.projects.toArray();
                        document.getElementById('widget-content-projects').innerHTML = projs.length ? `<div class="space-y-4">${projs.map(p => `<div onclick="logic.showDetails('projects', ${p.id})" class="p-4 bg-slate-50 border border-slate-100 rounded-2xl flex justify-between items-center cursor-pointer hover:border-indigo-200 transition-all"><span class="text-xs font-bold truncate pr-4">${p.name}</span> <span class="text-[10px] font-black bg-indigo-100 text-indigo-700 px-2 py-1 rounded">${p.progress}%</span></div>`).join('')}</div>` : '<p class="text-slate-300 text-sm italic">No active projects.</p>';
                    },
                    school: async () => {
                        const classes = await db.school.limit(3).toArray();
                        document.getElementById('widget-content-school').innerHTML = classes.length ? `<div class="space-y-3">${classes.map(c => `<div class="p-3 bg-indigo-50 border border-indigo-100 rounded-xl text-xs font-bold text-indigo-700">${c.className}</div>`).join('')}</div>` : '<p class="text-slate-300 text-sm italic">No classes.</p>';
                    },
                    extra: async () => {
                        const extras = await db.extra.limit(5).toArray();
                        document.getElementById('widget-content-extra').innerHTML = extras.length ? `<div class="space-y-3">${extras.map(e => `<div class="p-3 bg-white border border-slate-100 rounded-xl text-xs font-bold text-slate-600">${e.name}</div>`).join('')}</div>` : `<p class="text-slate-300 text-sm italic">No activities recorded.</p>`;
                    }
                };
                Object.keys(loaders).forEach(k => {
                    if(document.getElementById(`widget-content-${k}`)) loaders[k]();
                });
                lucide.createIcons();
            },

            events: async (target) => {
                const year = state.currentCalendarDate.getFullYear();
                const month = state.currentCalendarDate.getMonth();
                const monthName = state.currentCalendarDate.toLocaleString('default', { month: 'long' });
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const events = await db.events.toArray();
                target.innerHTML = `
                    <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full">
                        <div class="p-8 border-b flex justify-between items-center bg-white sticky top-0 z-30">
                            <div class="flex items-center gap-4">
                                <button onclick="renderers.changeMonth(-1)" class="p-2 hover:bg-slate-100 rounded-lg"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                                <h3 class="text-2xl font-bold">${monthName} ${year}</h3>
                                <button onclick="renderers.changeMonth(1)" class="p-2 hover:bg-slate-100 rounded-lg"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                            </div>
                            <button onclick="state.currentCalendarDate = new Date(); router.load('events')" class="text-xs font-bold text-indigo-600 hover:underline px-4">Jump to Today</button>
                        </div>
                        <div class="calendar-scroll-area hide-scrollbar">
                            <div class="calendar-grid bg-slate-200">
                                ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(h => `<div class="calendar-day-header p-4 text-center text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] border-r border-slate-200">${h}</div>`).join('')}
                                ${renderers.calculateCalendarDays(year, month, firstDay, daysInMonth, events)}
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
            },

            calculateCalendarDays: (year, month, firstDay, daysInMonth, events) => {
                let html = '';
                const today = new Date().toISOString().split('T')[0];
                const prevMonthDays = new Date(year, month, 0).getDate();
                for (let i = firstDay; i > 0; i--) html += `<div class="calendar-cell other-month flex flex-col"><span class="text-xs font-bold opacity-30">${prevMonthDays - i + 1}</span></div>`;
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateId = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayEvents = events.filter(e => e.start.startsWith(dateId));
                    const isToday = dateId === today;
                    html += `<div class="calendar-cell ${isToday ? 'today' : ''} flex flex-col group overflow-hidden"><div class="flex justify-between items-center mb-2"><span class="day-label text-xs font-bold text-slate-700">${day}</span></div><div class="flex-1 space-y-1">${dayEvents.map(e => `<div class="event-chip bg-indigo-600 text-white font-medium" onclick="logic.showDetails('events', ${e.id})">${e.title}</div>`).join('')}</div></div>`;
                }
                return html;
            },

            changeMonth: (offset) => { state.currentCalendarDate.setMonth(state.currentCalendarDate.getMonth() + offset); router.load('events'); },

            tasks: async (target) => {
                let tasks = await db.tasks.toArray();
                if (state.searchQuery) tasks = tasks.filter(t => t.title.toLowerCase().includes(state.searchQuery));
                
                const grouped = { pending: tasks.filter(t => t.status !== 'done'), completed: tasks.filter(t => t.status === 'done') };
                target.innerHTML = `
                    <div class="max-w-4xl mx-auto space-y-10"><section><h3 class="text-xs font-black uppercase text-slate-400 tracking-widest mb-6">Active Tasks</h3><div class="space-y-3">
                    ${grouped.pending.map(t => `<div class="bg-white p-6 rounded-3xl border border-slate-200 flex items-center justify-between group prio-${t.priority}"><div class="flex items-center gap-6"><input type="checkbox" onchange="logic.toggleTask(${t.id})" class="w-6 h-6"><div><p class="font-bold text-slate-800 cursor-pointer hover:underline" onclick="logic.showDetails('tasks', ${t.id})">${t.title}</p><p class="text-[10px] font-bold text-slate-400 mt-1 uppercase tracking-tighter">Due: ${t.dueDate || 'No Date'} • Priority: ${PRIORITY_LABELS[t.priority] || 'Medium'}</p></div></div><button onclick="logic.deleteData('tasks', ${t.id})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`).join('') || `<p class="text-slate-400 italic py-10 text-center">No pending tasks.</p>`}
                    </div></section><section class="opacity-50"><h3 class="text-xs font-black uppercase text-slate-400 tracking-widest mb-6">Completed</h3><div class="space-y-2">${grouped.completed.map(t => `<div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex items-center gap-4"><i data-lucide="check" class="w-4 h-4 text-green-500"></i> <span class="text-sm font-medium line-through cursor-pointer" onclick="logic.showDetails('tasks', ${t.id})">${t.title}</span></div>`).join('')}</div></section></div>
                `;
                lucide.createIcons();
            },

            settings: (target) => {
                target.innerHTML = `
                    <div class="max-w-3xl mx-auto space-y-12">
                        <section>
                            <h3 class="text-sm font-black uppercase tracking-widest text-slate-400 mb-6 flex items-center gap-2">
                                <i data-lucide="calendar" class="w-4 h-4"></i> Calendar Import
                            </h3>
                            <div class="bg-indigo-50 p-8 rounded-[2rem] border border-indigo-100 italic mb-4">
                                <h4 class="font-bold text-indigo-900 mb-2">How to Import from Google Calendar:</h4>
                                <ol class="text-xs text-indigo-700 space-y-2 list-decimal ml-4">
                                    <li>On your computer, open <b>Google Calendar</b>.</li>
                                    <li>In the top right, click <b>Settings</b> (the gear icon) -> <b>Settings</b>.</li>
                                    <li>On the left-hand menu, click <b>Import & Export</b>.</li>
                                    <li>Under Export, click the <b>Export</b> button to download a .zip file.</li>
                                    <li>Extract the .zip file and find the <b>.ics</b> file.</li>
                                    <li>Click the button below to upload that file!</li>
                                </ol>
                            </div>
                            <button onclick="document.getElementById('settings-ics-upload').click()" class="w-full py-6 bg-white border-2 border-dashed border-indigo-200 rounded-3xl font-bold text-indigo-600 flex flex-col items-center gap-2 hover:border-indigo-500 transition-all">
                                <i data-lucide="upload-cloud" class="w-6 h-6"></i>
                                Upload .ics File
                                <input type="file" id="settings-ics-upload" class="hidden" accept=".ics" onchange="logic.importIcs(this)">
                            </button>
                        </section>

                        <section><h3 class="text-sm font-black uppercase tracking-widest text-slate-400 mb-6 flex items-center gap-2"><i data-lucide="settings" class="w-4 h-4"></i> Feature Management</h3><div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 divide-y overflow-hidden">
                        ${Object.keys(state.config.features).map(key => `<div class="p-6 flex items-center justify-between hover:bg-slate-50 transition-colors"><div class="flex items-center gap-4"><div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center text-slate-500"><i data-lucide="${FEATURE_META[key].icon}" class="w-5 h-5"></i></div><div><p class="font-bold text-slate-700 capitalize">${key}</p><p class="text-xs text-slate-400">Enable or disable the ${key} module.</p></div></div><button onclick="logic.toggleFeature('${key}')" class="w-14 h-8 rounded-full relative transition-all ${state.config.features[key] ? 'bg-indigo-600' : 'bg-slate-300'}"><div class="w-6 h-6 bg-white rounded-full absolute top-1 transition-all ${state.config.features[key] ? 'right-1' : 'left-1'}"></div></button></div>`).join('')}
                        </div></section><section><h3 class="text-sm font-black uppercase tracking-widest text-slate-400 mb-6 flex items-center gap-2"><i data-lucide="cpu" class="w-4 h-4"></i> Automation Rules</h3><div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 p-8 space-y-6"><div class="flex items-center justify-between"><p class="font-bold text-sm text-slate-600">Auto-Carryover Overdue Tasks</p><input type="checkbox" onchange="logic.updateConfig('autoCarryover', this.checked)" ${state.config.automation.autoCarryover ? 'checked' : ''}></div></div></section><section><h3 class="text-sm font-black uppercase tracking-widest text-slate-400 mb-6 flex items-center gap-2"><i data-lucide="database" class="w-4 h-4"></i> Portability & Data</h3><div class="grid grid-cols-2 gap-4"><button onclick="logic.exportData()" class="p-6 bg-white border border-slate-200 rounded-3xl font-bold flex flex-col items-center gap-4 hover:border-indigo-500 transition-all"><i data-lucide="download" class="w-8 h-8 text-indigo-600"></i> Export Backup</button><button onclick="logic.factoryReset()" class="p-6 bg-red-50 border border-red-100 rounded-3xl font-bold text-red-600 flex flex-col items-center gap-4 hover:bg-red-100 transition-all"><i data-lucide="trash-2" class="w-8 h-8"></i> Wipe Database</button></div></section></div>
                `;
                lucide.createIcons();
            },

            projects: async (target) => {
                let projs = await db.projects.toArray();
                if (state.searchQuery) projs = projs.filter(p => p.name.toLowerCase().includes(state.searchQuery));
                
                target.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-8">${projs.map(p => `<div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 flex flex-col cursor-pointer transition-transform hover:scale-[1.01]" onclick="logic.showDetails('projects', ${p.id})"><h4 class="text-xl font-bold mb-6">${p.name}</h4><div class="mt-auto"><div class="flex justify-between text-[10px] font-black text-slate-400 uppercase mb-2"><span>Completion</span><span>${p.progress}%</span></div><div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden"><div class="bg-indigo-600 h-full transition-all" style="width: ${p.progress}%"></div></div><div class="flex gap-2 mt-8" onclick="event.stopPropagation()"><button onclick="logic.updateProjectProgress(${p.id}, 10)" class="flex-1 py-3 text-xs font-bold bg-slate-50 border border-slate-100 rounded-xl hover:bg-slate-100">+10%</button><button onclick="logic.deleteData('projects', ${p.id})" class="p-3 text-red-500 hover:bg-red-50 rounded-xl transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div></div>`).join('') || '<p class="col-span-full text-center text-slate-400 italic py-10">No active projects yet.</p>'}</div>`;
                lucide.createIcons();
            },

            habits: async (target) => {
                const list = await db.habits.toArray();
                target.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    ${list.map(h => `
                        <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-200 flex flex-col items-center text-center relative group">
                            <button onclick="logic.deleteData('habits', ${h.id})" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><i data-lucide="x" class="w-5 h-5"></i></button>
                            <h4 class="font-bold text-slate-700 mb-4">${h.name}</h4>
                            <div class="text-5xl font-black text-indigo-600 mb-1">${h.streak}</div>
                            <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-8">Current Streak</p>
                            <div class="w-full flex gap-2">
                                <button onclick="logic.incrementHabit(${h.id})" class="flex-1 py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-xl shadow-indigo-100 hover:scale-105 active:scale-95 transition-all">+ Log</button>
                                <button onclick="logic.resetHabit(${h.id})" class="p-4 bg-slate-50 border rounded-2xl text-slate-400 hover:text-orange-500 transition-all" title="Reset Streak"><i data-lucide="refresh-ccw" class="w-5 h-5"></i></button>
                            </div>
                        </div>
                    `).join('') || '<p class="col-span-full text-center text-slate-400 italic py-10">Start tracking a habit to build streaks!</p>'}
                </div>`;
                lucide.createIcons();
            },

            school: async (target) => {
                const classes = await db.school.toArray();
                const tasks = await db.tasks.toArray(); 
                target.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                        <section class="space-y-6">
                            <h3 class="text-xs font-black uppercase text-slate-400 tracking-widest flex justify-between items-center">
                                <span>Active Classes</span>
                            </h3>
                            ${classes.map(c => `<div class="bg-indigo-900 text-white p-6 rounded-3xl shadow-xl overflow-hidden relative group">
                                <i data-lucide="graduation-cap" class="absolute -right-4 -bottom-4 w-24 h-24 opacity-10"></i>
                                <div class="relative z-10">
                                    <h4 class="text-lg font-bold mb-1">${c.className}</h4>
                                    <p class="text-xs opacity-60 font-medium">${c.instructor || 'No Instructor'}</p>
                                    <button onclick="logic.deleteData('school', ${c.id})" class="mt-4 text-[10px] uppercase font-bold text-white/40 hover:text-white transition-opacity">Remove</button>
                                </div>
                            </div>`).join('') || '<p class="text-slate-400 italic">No classes found. Add one to start tracking assignments.</p>'}
                        </section>
                        <section class="space-y-4">
                            <h3 class="text-xs font-black uppercase text-slate-400 tracking-widest">School Assignments</h3>
                            <div class="space-y-2">
                                ${tasks.filter(t => t.classId && t.classId !== "").map(t => `<div class="p-4 bg-white border border-slate-200 rounded-2xl flex justify-between items-center group cursor-pointer hover:border-indigo-300" onclick="logic.showDetails('tasks', ${t.id})">
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" onchange="event.stopPropagation(); logic.toggleTask(${t.id})" ${t.status === 'done' ? 'checked' : ''}>
                                        <span class="text-sm font-bold text-slate-700 ${t.status === 'done' ? 'line-through opacity-40' : ''}">${t.title}</span>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <span class="text-[10px] font-black uppercase text-slate-300">${classes.find(c => c.id == t.classId)?.className || 'Linked'}</span>
                                        <button onclick="event.stopPropagation(); logic.deleteData('tasks', ${t.id})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>`).join('') || '<p class="text-slate-400 italic">No homework linked to classes. Click "New Assignment" to add some!</p>'}
                            </div>
                        </section>
                    </div>
                `;
                lucide.createIcons();
            },

            extra: async (target) => {
                const extras = await db.extra.toArray();
                target.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">${extras.map(e => `<div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex justify-between items-center group"><span class="font-bold text-slate-700">${e.name}</span> <button onclick="logic.deleteData('extra', ${e.id})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`).join('') || '<p class="col-span-full text-center text-slate-400 italic py-10">No activities listed.</p>'}</div>`;
                lucide.createIcons();
            }
        };

        /**
         * 6. AUTOMATION SYSTEM 
         */
        const automation = {
            runner: async () => {
                if (!state.config.automation.autoCarryover) return;
                const today = new Date().toISOString().split('T')[0];
                const overdue = await db.tasks.where('dueDate').below(today).and(t => t.status !== 'done').toArray();
                if (overdue.length > 0) {
                    for (let task of overdue) await db.tasks.update(task.id, { dueDate: today });
                }
            }
        };

        /**
         * 7. CORE BUSINESS LOGIC 
         */
        const logic = {
            search: (val) => {
                state.searchQuery = val.toLowerCase();
                if (state.currentView !== 'dashboard') router.load(state.currentView);
            },

            togglePomodoro: () => {
                if (state.pomodoro.active) {
                    clearInterval(state.pomodoro.interval);
                    state.pomodoro.active = false;
                } else {
                    state.pomodoro.active = true;
                    state.pomodoro.interval = setInterval(() => {
                        state.pomodoro.time--;
                        if(state.pomodoro.time <= 0) logic.togglePomodoro();
                        if(document.getElementById('pomo-timer')) document.getElementById('pomo-timer').innerText = `${Math.floor(state.pomodoro.time/60)}:${(state.pomodoro.time%60).toString().padStart(2, '0')}`;
                    }, 1000);
                }
                router.load('dashboard');
            },

            showImportInstructions: () => {
                const html = `
                    <div class="space-y-6 text-slate-600">
                        <div class="p-4 bg-indigo-50 border border-indigo-100 rounded-2xl flex gap-4">
                            <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center shrink-0 font-bold">1</div>
                            <p class="text-sm">On your computer, open <b>calendar.google.com</b>.</p>
                        </div>
                        <div class="p-4 bg-white border rounded-2xl flex gap-4">
                            <div class="w-8 h-8 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center shrink-0 font-bold">2</div>
                            <p class="text-sm">Click the <b>Gear icon (⚙️)</b> at the top right, then select <b>Settings</b>.</p>
                        </div>
                        <div class="p-4 bg-white border rounded-2xl flex gap-4">
                            <div class="w-8 h-8 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center shrink-0 font-bold">3</div>
                            <p class="text-sm">On the left sidebar, click <b>Import & Export</b>.</p>
                        </div>
                        <div class="p-4 bg-white border rounded-2xl flex gap-4">
                            <div class="w-8 h-8 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center shrink-0 font-bold">4</div>
                            <p class="text-sm">Find the <b>Export</b> section and click the Export button. This downloads a <b>.zip</b> file.</p>
                        </div>
                        <div class="p-4 bg-white border rounded-2xl flex gap-4">
                            <div class="w-8 h-8 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center shrink-0 font-bold">5</div>
                            <p class="text-sm">Unzip the file on your computer and upload the <b>.ics</b> file here.</p>
                        </div>
                    </div>
                `;
                ui.modal.open("How to Export", "Follow these steps to sync your Google Calendar", html);
            },

            importIcs: async (input) => {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const jcalData = ICAL.parse(e.target.result);
                        const comp = new ICAL.Component(jcalData);
                        const vevents = comp.getAllSubcomponents('vevent');
                        let count = 0;
                        for (const vevent of vevents) {
                            const event = new ICAL.Event(vevent);
                            await db.events.add({
                                title: event.summary,
                                start: event.startDate.toJSDate().toISOString(),
                                end: event.endDate.toJSDate().toISOString(),
                                description: event.description || '',
                                createdAt: Date.now()
                            });
                            count++;
                        }
                        alert(`Success! Imported ${count} events into your calendar.`);
                        router.load(state.currentView);
                    } catch (err) {
                        console.error(err);
                        alert("Error parsing .ics file. Please ensure it is a valid calendar export.");
                    }
                };
                reader.readAsText(file);
            },

            handleForm: async (e, key, id = null) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const data = Object.fromEntries(fd.entries());
                
                if (id) {
                    await db[key].update(id, data);
                } else {
                    data.createdAt = Date.now();
                    if(key === 'tasks') { data.status = 'pending'; }
                    if(key === 'projects') { data.progress = 0; data.status = 'active'; }
                    if(key === 'habits') { data.streak = 0; data.logs = []; }
                    await db[key].add(data);
                }
                
                ui.modal.close();
                router.load(state.currentView);
            },

            showDetails: async (table, id) => {
                const item = await db[table].get(id);
                if (!item) return;

                let content = `<div class="space-y-8">`;
                content += `
                    <div class="grid grid-cols-2 gap-6 bg-white p-6 rounded-3xl border border-slate-100">
                        <div><p class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-1">Status</p><p class="font-bold text-indigo-600 capitalize">${item.status || 'Active'}</p></div>
                        ${item.priority ? `<div><p class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-1">Priority</p><p class="font-bold text-slate-800">${PRIORITY_LABELS[item.priority]}</p></div>` : ''}
                        ${item.dueDate || item.deadline ? `<div><p class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-1">Due Date</p><p class="font-bold text-slate-800">${item.dueDate || item.deadline}</p></div>` : ''}
                        ${item.start ? `<div><p class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-1">Scheduled</p><p class="font-bold text-slate-800">${new Date(item.start).toLocaleString()}</p></div>` : ''}
                        <div><p class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-1">Created At</p><p class="font-bold text-slate-800">${new Date(item.createdAt).toLocaleDateString()}</p></div>
                    </div>
                `;

                content += `
                    <div class="space-y-3">
                        <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Description & Notes</p>
                        <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100 min-h-[120px]">
                            <p class="text-sm text-slate-600 leading-relaxed whitespace-pre-wrap">${item.description || 'No description provided.'}</p>
                        </div>
                    </div>
                `;
                content += `</div>`;

                const actionsHtml = `<button onclick="ui.modal.renderForm('${table}', ${id})" class="px-4 py-2 bg-slate-100 font-bold text-xs rounded-xl hover:bg-slate-200 transition-all">Edit Item</button>`;
                ui.modal.open(item.title || item.name, "Detailed Overview", content, actionsHtml);
            },

            toggleTask: async (id) => {
                const task = await db.tasks.get(id);
                await db.tasks.update(id, { status: task.status === 'done' ? 'pending' : 'done' });
                router.load(state.currentView);
            },

            incrementHabit: async (id) => {
                const habit = await db.habits.get(id);
                await db.habits.update(id, { streak: (parseInt(habit.streak) || 0) + 1 });
                router.load(state.currentView);
            },

            resetHabit: async (id) => {
                if(confirm("Reset this habit streak to zero?")) {
                    await db.habits.update(id, { streak: 0 });
                    router.load(state.currentView);
                }
            },

            updateProjectProgress: async (id, inc) => {
                const p = await db.projects.get(id);
                const newProg = Math.min((parseInt(p.progress) || 0) + inc, 100);
                await db.projects.update(id, { progress: newProg });
                router.load(state.currentView);
            },

            deleteData: async (table, id) => {
                if(confirm("Permanently delete this item?")) {
                    await db[table].delete(id);
                    router.load(state.currentView);
                }
            },

            toggleFeature: (key) => {
                state.config.features[key] = !state.config.features[key];
                logic.saveConfig();
                ui.refreshNavigation();
                router.load('settings');
            },

            updateConfig: (key, val) => {
                state.config.automation[key] = val;
                logic.saveConfig();
            },

            saveConfig: () => localStorage.setItem('app_config', JSON.stringify(state.config)),

            exportData: async () => {
                const results = {};
                for (const table of db.tables) results[table.name] = await table.toArray();
                const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `backup_${new Date().getTime()}.json`;
                a.click();
            },

            factoryReset: async () => {
                if(confirm("Factory reset? This deletes ALL data permanently.")) {
                    await db.delete();
                    localStorage.clear();
                    window.location.reload();
                }
            }
        };

        window.onload = ui.init;
    </script>
</body>
</html>
